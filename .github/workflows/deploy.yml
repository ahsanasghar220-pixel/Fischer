name: Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Cache frontend build
        id: cache-build
        uses: actions/cache@v3
        with:
          path: frontend/dist
          key: ${{ runner.os }}-build-${{ hashFiles('frontend/src/**/*', 'frontend/public/**/*', 'frontend/index.html', 'frontend/vite.config.ts', 'frontend/tailwind.config.js') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Build frontend
        if: steps.cache-build.outputs.cache-hit != 'true'
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Verify build exists
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "ERROR: frontend/dist directory not found!"
            exit 1
          fi
          echo "âœ“ Build directory exists"
          ls -lh frontend/dist/ | head -10

      - name: Create deployment package
        run: |
          # Create deployment directory
          mkdir -p deploy

          # Copy backend files (WITHOUT vendor - will install on server)
          cp -r backend/* deploy/
          rm -rf deploy/vendor

          # Copy frontend build to public folder
          cp -r frontend/dist/* deploy/public/

          # Remove unnecessary files
          rm -rf deploy/tests
          rm -rf deploy/storage/logs/*
          rm -rf deploy/.git
          rm -f deploy/.env.example
          rm -f deploy/phpunit.xml

          # Create required directories
          mkdir -p deploy/storage/app/public
          mkdir -p deploy/storage/framework/cache
          mkdir -p deploy/storage/framework/sessions
          mkdir -p deploy/storage/framework/views
          mkdir -p deploy/storage/logs
          mkdir -p deploy/bootstrap/cache

          # Debug: Show what's in deploy folder
          echo "=== Deploy folder contents ==="
          ls -la deploy/
          echo "=== composer.json exists? ==="
          cat deploy/composer.json | head -5

      - name: Test SSH connectivity
        run: |
          echo "=== Testing SSH connectivity ==="
          echo "Host: ${{ secrets.SSH_HOST }}"
          echo "Port: ${{ secrets.SSH_PORT }}"
          nc -zv -w 10 ${{ secrets.SSH_HOST }} ${{ secrets.SSH_PORT }} 2>&1 || echo "TCP connection FAILED"
          echo "=== Deploy package size ==="
          du -sh deploy/

      - name: Deploy to Hostinger via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "./deploy/*"
          target: ${{ secrets.SSH_SERVER_DIR }}
          strip_components: 1
          rm: false
          overwrite: true
          timeout: 300s
          command_timeout: 10m
          debug: true

      - name: Post-deployment tasks
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 15m
          script: |
            cd ${{ secrets.SSH_SERVER_DIR }}

            # PHP 8.2 path on Hostinger
            PHP=/opt/alt/php82/usr/bin/php

            echo "=== PHP Version ==="
            $PHP -v

            # Find composer location
            COMPOSER=$(which composer 2>/dev/null || echo "/usr/local/bin/composer")
            echo "=== Composer location: $COMPOSER ==="

            # Only reinstall vendor if composer.lock changed
            if [ ! -d "vendor" ] || [ "composer.lock" -nt "vendor" ]; then
              echo "=== Installing composer dependencies ==="
              $PHP $COMPOSER install --no-dev --optimize-autoloader --no-interaction 2>&1 || {
                echo "Trying alternative composer path..."
                $PHP /opt/cpanel/composer/bin/composer install --no-dev --optimize-autoloader --no-interaction 2>&1 || {
                  echo "Trying to download composer..."
                  curl -sS https://getcomposer.org/installer | $PHP
                  $PHP composer.phar install --no-dev --optimize-autoloader --no-interaction
                }
              }
            else
              echo "=== Vendor directory up to date, skipping composer install ==="
            fi

            # Set permissions
            chmod -R 755 storage bootstrap/cache

            # Ensure required directories exist
            mkdir -p resources/views storage/app/public storage/framework/cache storage/framework/sessions storage/framework/views storage/logs bootstrap/cache

            # Generate APP_KEY if not set
            if ! grep -q "APP_KEY=base64:" .env; then
              echo "=== Generating APP_KEY ==="
              $PHP artisan key:generate --force
            fi

            # Clear config cache before migrations
            $PHP artisan config:clear

            # Run migrations (preserves existing data)
            echo "=== Running migrations ==="
            $PHP artisan migrate --force 2>&1

            # Check queue worker status (visitor tracking runs in background queue)
            # IMPORTANT: Ensure queue worker is running: php artisan queue:work --tries=3 --daemon
            # You can check with: ps aux | grep "queue:work"
            echo "=== Queue Worker Status ==="
            ps aux | grep "queue:work" | grep -v grep || echo "WARNING: Queue worker not running. Start with: php artisan queue:work --tries=3 --daemon &"

            # Always run safe/idempotent seeders
            echo "=== Running safe seeders ==="
            $PHP artisan db:seed --class=ShippingZoneSeeder --force || true
            $PHP artisan db:seed --class=ShippingMethodSeeder --force || true
            $PHP artisan db:seed --class=RolePermissionSeeder --force || true
            $PHP artisan db:seed --class=HomepageSeeder --force || true
            $PHP artisan db:seed --class=PortfolioVideoSeeder --force || true
            echo "=== Safe seeders completed ==="

            # Only run other seeders if SEED_ON_DEPLOY file exists (create this file manually when needed)
            if [ -f "SEED_ON_DEPLOY" ]; then
              echo "=== SEED_ON_DEPLOY detected, running additional seeders ==="
              $PHP artisan db:seed --class=CategorySeeder --force || true
              $PHP artisan db:seed --class=ProductSeeder --force || true
              $PHP artisan db:seed --class=ProductDataSeeder --force || true
              $PHP artisan db:seed --class=BannerSeeder --force || true
              $PHP artisan db:seed --class=HomepageSeeder --force || true
              $PHP artisan db:seed --class=SettingsSeeder --force || true
              $PHP artisan db:seed --class=PageSeeder --force || true
              rm -f SEED_ON_DEPLOY
              echo "=== Additional seeders completed ==="
            else
              echo "=== Skipping additional seeders (create SEED_ON_DEPLOY file to run) ==="
            fi

            # Clear all caches
            echo "=== Clearing caches ==="
            $PHP artisan cache:clear || true
            $PHP artisan config:clear
            $PHP artisan route:clear
            $PHP artisan view:clear || true

            # Rebuild caches for production performance
            echo "=== Rebuilding caches ==="
            $PHP artisan config:cache
            $PHP artisan route:cache
            $PHP artisan view:cache

            # Create storage link manually (exec() is disabled on Hostinger)
            rm -rf public/storage
            ln -s ../storage/app/public public/storage
            echo "=== Storage link created ==="

            echo "=== Deployment completed successfully ==="
            $PHP artisan --version

      - name: Notify on success
        if: success()
        run: echo "Deployment completed successfully!"

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed!"
